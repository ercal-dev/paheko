{{#restrict section="accounting" level="read"}}

{{* ==================== Header ==================== *}}

{{:admin_header title="Devis et factures" current="acc" custom_css="./include/style.css"}}
{{:include file='./include/navigation.html'}}
{{:include file='./include/constants.tpl' keep='DRAFT_STATUS, AWAITING_STATUS, VALIDATED_STATUS, REJECTED_STATUS, PAID_STATUS, QUOTATION_TYPE, INVOICE_TYPE'}}

{{* ==================== Listing ==================== *}}

{{#sql select='id' tables='module_data_invoice'}}
	{{:assign found=true}}
{{/sql}}

{{if !$found}}
	<p class="infos">Aucun devis.</p>
	{{#restrict section="accounting" level="write"}}
		<p class="infos">{{:linkbutton href="edit.html" label="Cr√©er un devis" shape="plus"}}</p>
	{{/restrict}}
{{/if}}

<table class="list">
	<thead>
		<tr>
			<th>Nom</th>
			<th class="num">Devis en attente</th>
			<th class="num">Devis valid√©s</th>
			<th class="num">Devis rejet√©s</th>
			<th class="num">Fact. en souffr.</th>
			<th class="num">Fact. r√©gl√©es</th>
			<th class="num">Brouillons</th>
		</tr>
	</thead>
	<tbody>
{{:assign previous_customer='-1'}}
{{:assign previous=null}}
{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$AWAITING_STATUS value=0}}
{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$VALIDATED_STATUS value=0}}
{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$REJECTED_STATUS value=0}}
{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$DRAFT_STATUS value=0}}
{{:assign var='status_number.%s.%s'|args:$INVOICE_TYPE:$AWAITING_STATUS value=0}}
{{:assign var='status_number.%s.%s'|args:$INVOICE_TYPE:$PAID_STATUS value=0}}

{{:assign where="json_extract(document, '$.cancelled') = false"}}
{{if !$_GET.count_archived}}
	{{:assign where=$where|cat:" AND json_extract(document, '$.archived') = false"}}
{{/if}}
{{#sql
	select="
		json_extract(document, '$.recipient_business_name') AS recipient_business_name,
		json_extract(document, '$.recipient_member_id') AS customer_id,
		json_extract(document, '$.status') AS status,
		json_extract(document, '$.type') AS type,
		COUNT(json_extract(document, '$.status')) AS document_status_quantity
	"
	tables='module_data_invoice'
	where=$where
	group='recipient_business_name, type, status'
	order='recipient_business_name, type, status'
}}
	{{if $recipient_business_name !== $previous_customer && $previous_customer !== '-1'}}
		<tr>
			<td>{{:link href="./customer.html?show=customers&id=%s"|args:$previous.recipient_business_name label=$previous.recipient_business_name}}</td>
			<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$AWAITING_STATUS}}{{$number}}</td>
			<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$VALIDATED_STATUS}}{{$number}}</td>
			<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$REJECTED_STATUS}}{{$number}}</td>
			<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$INVOICE_TYPE:$AWAITING_STATUS}}{{$number}}</td>
			<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$INVOICE_TYPE:$PAID_STATUS}}{{$number}}</td>
			<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$DRAFT_STATUS}}{{$number}}</td>
		</tr>
		{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$AWAITING_STATUS value=0}}
		{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$VALIDATED_STATUS value=0}}
		{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$REJECTED_STATUS value=0}}
		{{:assign var='status_number.%s.%s'|args:$QUOTATION_TYPE:$DRAFT_STATUS value=0}}
		{{:assign var='status_number.%s.%s'|args:$INVOICE_TYPE:$AWAITING_STATUS value=0}}
		{{:assign var='status_number.%s.%s'|args:$INVOICE_TYPE:$PAID_STATUS value=0}}
	{{/if}}
	{{:assign var='status_number.%s.%s'|args:$type:$status value=$document_status_quantity}}
	{{:assign previous_customer=$recipient_business_name}}
	{{:assign .='previous'}}
{{/sql}}

{{if $previous}}
	<tr>
		<td>{{:link href="./customer.html?show=customers&id=%s"|args:$previous.recipient_business_name label=$previous.recipient_business_name}}</td>
		<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$AWAITING_STATUS}}{{$number}}</td>
		<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$VALIDATED_STATUS}}{{$number}}</td>
		<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$REJECTED_STATUS}}{{$number}}</td>
		<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$INVOICE_TYPE:$AWAITING_STATUS}}{{$number}}</td>
		<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$INVOICE_TYPE:$PAID_STATUS}}{{$number}}</td>
		<td class="num">{{:assign var='number' from='status_number.%s.%s'|args:$QUOTATION_TYPE:$DRAFT_STATUS}}{{$number}}</td>
	</tr>
{{/if}}

	</tbody>
</table>

{{if !$_GET.count_archived}}
	<p>
		Les documents archiv√©s ne sont pas comptabilis√©s ici.<br />
		{{:link href="./customers.html?show=customers&count_archived=true" label="Recalculer en comptabilisant les documents archiv√©s"}}.
	</p>
{{else}}
	<p>
		Cette liste comprend les documents archiv√©s üóÉ.<br />
		{{:link href="./customers.html?show=customers" label="Retirer les documents archiv√©s du d√©compte"}}.
	</p>
{{/if}}

{{:admin_footer}}

{{else}}
	{{:error message="Seuls les membres avec acc√®s en lecture √† la comptabilit√© peuvent visualiser cette page."}}
{{/restrict}}

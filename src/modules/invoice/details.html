{{#restrict section="accounting" level="read"}}

{{* ==================== Header ==================== *}}

{{:admin_header title="Devis et factures" current="acc" custom_css="./include/style.css"}}
{{:include file='./include/constants.tpl' keep='DRAFT_STATUS, AWAITING_STATUS, VALIDATED_STATUS, REJECTED_STATUS, PAID_STATUS, DOCUMENT_TYPES, TYPE_LABELS, STATUS_LABELS, INVOICE_STATUS_LABELS, CANCELLED_LABEL, QUOTATION_TYPE, INVOICE_TYPE, VERSION'}}

{{if $_GET.id === null}}
	<p class="error block">Aucun document séléctionné.</p>
{{else}}
	{{#load id=$_GET.id|intval}}

		{{* ======================= Menu =========================== *}}
		
		{{:include file='./include/document_details_menu.html'}}

		{{* ======================= Feedback =========================== *}}

		{{if $_GET.ok}}
			<p class="block confirm">
			{{if $_GET.ok === '1'}}
				Devis signé avec succès.
			{{elseif $_GET.ok === '2'}}
				Modification enregistrée.
			{{elseif $_GET.ok === '3'}}
				Brouillon conservé.
			{{elseif $_GET.ok === '4'}}
				Devis marqué avec succès comme refusé.
			{{elseif $_GET.ok === '5'}}
				Devis marqué avec succès comme validé.
			{{elseif $_GET.ok === '6'}}
				Facture marquée avec succès comme payée.
			{{/if}}
			</p>
		{{/if}}

		{{* ======================= Title =========================== *}}

		{{:assign var="label" from="TYPE_LABELS.%s"|args:$type}}
		{{if $type === $INVOICE_TYPE}}
			{{:assign var="status_label" from="INVOICE_STATUS_LABELS.%s"|args:$status}}
			{{:assign cancelled_label='Annulée'}}
		{{else}}
			{{:assign var="status_label" from="STATUS_LABELS.%s"|args:$status}}
			{{:assign cancelled_label='Annulé'}}
		{{/if}}
		<h1>{{$label}} n° {{$key}} - {{if !$cancelled}}{{$status_label}}{{else}}{{$cancelled_label}}{{/if}}</h1>

		{{* ======================= Content =========================== *}}

		<fieldset>
			<legend><h2>Informations</h2></legend>
			
			{{if $cancelled}}
				<p>Statut en cours : <strong class="irreversible">{{$cancelled_label}}</strong>.
				{{if $cancellation_reason}}<p>Motif : {{$cancellation_reason|escape|nl2br}}</p>{{/if}}
				<p class="infos">(dernier statut avant annulation : {{$status_label}})</p>
			{{elseif $status === $AWAITING_STATUS}}
				<p class="infos">{{$label}} <strong>{{if $type === $QUOTATION_TYPE}}signé{{else}}émise{{/if}} le {{$signing_date|date_short}} à {{$signing_place}}</strong>.</p>
				{{if $type === $QUOTATION_TYPE}}
					<p class="">En attente de validation par le/la client.e.</p>
					<p class="infos">
						{{:linkbutton href="action.html?id=%d&show=quotation&action=ask_validation"|args:$id label="Marquer comme validé et générer la facture" shape="check"}}
						{{:linkbutton href="action.html?id=%d&show=quotation&action=ask_rejection"|args:$id label="Marquer comme refusé" shape="alert"}}
					</p>
				{{else}}
					<p class="">En attente de paiement.</p>
					<p class="infos">
						{{:linkbutton href="action.html?id=%d&show=invoice&action=ask_mark_as_paid"|args:$id label="Marquer comme payée" shape="check"}}
						{{* {{:linkbutton href="action.html?id=%d&show=quotation&action=ask_rejection"|args:$id label="Marquer comme abandonnée" shape="alert"}} *}}
					</p>
				{{/if}}

			{{elseif $status === $VALIDATED_STATUS}}
				<p class="infos">{{$label}} <strong>validé le {{$validation_date|date_short}}</strong> (signé par l'asso le {{$signing_date|date_short}}).</p>
				{{if $type === $QUOTATION_TYPE && $child_id}}
					{{#load id=$child_id|intval}}{{:assign .='child'}}{{/load}}
					<p class="infos">Facture correspondante : {{:link href="?id=%d&show=invoice"|args:$child.id label="n°%s"|args:$child.key}}.</p>
				{{/if}}

			{{elseif $status === $PAID_STATUS}}
				<p class="infos">{{$label}} <strong>payée le {{$payment_date|date_short}}</strong> (émise par l'asso le {{$signing_date|date_short}}).</p>
				{{if $payment_comment}}
					<h4>Remarques sur le paiement :</h4>
					<p class="infos">{{$payment_comment|escape|nl2br}}</p>
				{{/if}}
				{{if $transaction_id}}
					{{#transactions id=$transaction_id|intval}}
						<p class="infos">Écriture comptable correspondante : {{:link href='!acc/transactions/details.php?id=%d'|args:$id label='n°%d - %s'|args:$id:$label}}.</p>
					{{/transactions}}
				{{else}}
					<p class="infos">Aucune écriture comptable correspondante. {{:linkbutton href="#" label="Associer (prochainement)" shape="right"}}</p>
				{{/if}}

			{{else}}
				<p class="infos">Statut en cours : {{$status_label}}.</p>
			{{/if}}

			{{if $type === $INVOICE_TYPE && $parent_id}}
				{{#load id=$parent_id}}{{:assign .='parent'}}{{/load}}
				<p class="infos">Correspondant au {{:link href="details.html?id=%d&show=quotation"|args:$parent.id label="devis n°%s"|args:$parent.key}}.</p>
			{{/if}}

			{{#users id=$author_id|intval}}{{:assign .='author'}}{{/users}}
			<p>
				{{if $type === $QUOTATION_TYPE}}Rédigé{{else}}Rédigée{{/if}} par : {{:link href="!users/details.php?id=%d"|args:$author.id label=$author.nom}}.
			</p>
			<p>
				Dernière modification : {{$last_modification_date}}.
			</p>
			{{if $duplicated_from_id}}
				{{if $type === $INVOICE_TYPE}}
					{{:assign duplicate_label="facture n°%s"}}
				{{else}}
					{{:assign duplicate_label="devis n°%s"}}
				{{/if}}
				{{#load id=$duplicated_from_id}}{{:assign .='parent'}}{{/load}}
				{{if $parent}} {{* if the parent was a draft it may have been deleted since the duplication *}}
					<p>
						Dupliqué depuis {{if $type === $INVOICE_TYPE}}la{{else}}le{{/if}}
						{{:link href="details.html?id=%d&show=quotation"|args:$parent.id label=$duplicate_label|args:$parent.key}}
						({{if $parent.cancelled}}{{$CANCELLED_LABEL}}{{else}}{{:assign var='parent_status_label' from="INVOICE_STATUS_LABELS.%s"|args:$parent.status}}{{$parent_status_label}}{{/if}}).
					</p>
				{{/if}}
			{{/if}}
		</fieldset>

		<fieldset>
			<legend><h2>Destinataire</h2></legend>
			<p class="infos">
				<strong class="business_name">{{$recipient_business_name}}</strong><br />
				{{$recipient_address|escape|nl2br}}
			</p>
			{{if $recipient_member_id}}
				{{#users id=$recipient_member_id|intval}}{{:assign .='member'}}{{/users}}
				{{if !$member}}
					<p class="infos">Associé à l'ancien.ne membre {{if $recipient_member_number}}n°{{$recipient_member_number}}{{else}}#{{$recipient_member_id}}{{/if}} (compte supprimé).</p>
				{{else}}
					<p class="infos">
						Associé au membre {{if $recipient_member_number}}n°{{$recipient_member_number}}{{/if}} : "{{:link href="!users/details.php?id=%d"|args:$member.id label=$member.nom}}",
						{{if $recipient_business_name !== $member.nom}} sous la désignation "{{$recipient_business_name}}".{{/if}}<br />
						{{:link href="customer.html?show=customers&id=%s"|args:$recipient_business_name label='Voir tous les devis de "%s".'|args:$recipient_business_name}}
					</p>
				{{/if}}
			{{/if}}
		</fieldset>

		<fieldset>
			<legend><h2>Objet</h2></legend>
			<ul>
				<li>Intitulé : {{$subject}}</li>
				<li>Date : {{$date|date_short}}</li>
				{{if $deadline}}<li>Échéance : {{$deadline|date_short}}</li>{{/if}}
				<li>Référence : {{$key}}</li>
				<li>Total : {{$total|floatval|money_currency:false}}</li>
			</ul>
		</fieldset>
		
		<fieldset>
			<legend><h2>Articles</h2></legend>
			{{if $items}}
				<table id="item_list" class="list">
					<tr>
						<th>Réf.</th>
						<th>Dénomination</th>
						<th>Description</th>
						<th>Prix unitaire</th>
						<th>Quantité</th>
					</tr>
					{{#foreach from=$items item='item'}}
						<tr>
							<td>{{$item.reference}}</td>
							<td>{{$item.name}}</td>
							<td>{{$item.description|escape|nl2br}}</td>
							<td>{{$item.unit_price|intval|money:false}}</td>
							<td>{{$item.quantity}}</td>
						</tr>
					{{/foreach}}
				</table>
			{{else}}
				<p>Aucun article.</p>
			{{/if}}
		</fieldset>
		
		<fieldset>
			<legend><h2>Infos</h2></legend>
			<ul>
				<li class="infos">Contact : {{$org_contact}}</li>
				{{if $introduction_text}}
					<li>
						Texte d'introduction :
						<p>{{$introduction_text|escape|nl2br}}</p>
					</li>
				{{/if}}
			</ul>
		</fieldset>

		<form method="POST" action="{{"action.html?id=%d&show=%s&action=edit_comment"|args:$id:$type}}">
			<fieldset>
				<legend>
					<h2>Remarques internes{{if $comment}}{{:button type="submit" title="Éditer les remarques" shape="edit" name="edit_comment_button"}}{{/if}}</h2>
				</legend>
				{{if $comment}}
					<p>{{$comment|escape|nl2br}}</p>
				{{else}}
					<p class="infos">Aucune.</p>
					<p>{{:button type="submit" label="Ajouter des remarques" shape="plus" name="edit_comment_button"}}</p>
				{{/if}}
			</fieldset>
		</form>

		{{if $payment_text || $extra_text}}
			<fieldset>
				<legend><h2>Infos complémentaires</h2></legend>
				{{if $payment_text}}<p>{{$payment_text|escape|nl2br}}</p>{{/if}}
				{{if $extra_text}}<p>{{$extra_text|escape|nl2br}}</p>{{/if}}
			</fieldset>
		{{/if}}

		{{#restrict section="config" level="admin"}}
			<div style="background-color: black; color: limegreen; padding: 1em;">
				<fieldset style="border-color: limegreen;">
					<legend><h2 style="color: limegreen;">Outils développeur/euse</h2></legend>
					<div class="infos inline">
						<label for="f_status">Statut en cours :</label>
						<form method="POST" action="./action.html" style="display: inline;">
							{{if $type === $INVOICE_TYPE}}{{:assign options=$INVOICE_STATUS_LABELS}}{{else}}{{:assign options=$STATUS_LABELS}}{{/if}}
							{{:input type="select" name="status" options=$options default=$status required=true}}
							{{* {{:input type="checkbox" name="cancelled" label="annulé" value='1' default=$cancelled style="display: inline;"}} *}}
							<input type="checkbox"  name="cancelled" {{if $cancelled}}checked="checked"{{/if}} value="1" id="f_cancelled_1" style="display: inline;" />
							<label id="cancel_checkbox_label" for="f_cancelled_1">annulé</label>
							{{:input type="hidden" name="id" default=$id|intval}}
							{{:button type="submit" name="status_update_button" label="Modifier"}}
						</form>
					</div>
				</fieldset>
			</div>
			<style>#cancel_checkbox_label::before { margin-right: 0; }</style>
		{{/restrict}}

	{{else}}
		<p class="error block">Document introuvable (ID : #{{$_GET.id}}).</p>
	{{/load}}
{{/if}}

{{:admin_footer}}

{{else}}
	{{:error message="Seuls les membres avec accès en lecture à la comptabilité peuvent visualiser cette page."}}
{{/restrict}}

{{#restrict section="accounting" level="read"}}

{{if !$_GET.id}}
	<p class="error block">Aucun document séléctionné.</p>
{{/if}}

{{#load id=$_GET.id}}

{{:include file='./include/preview_style.tpl'}}
{{:include file='./include/constants.tpl' keep='DRAFT_STATUS, TYPE_LABELS, STATUS_LABELS, CANCELLED_LABEL, NONPROFIT_VAT_EXEMPTION_TYPE'}}
{{:assign var="document_type_label" from="TYPE_LABELS.%s"|args:$type}}
{{:assign var='DRAFT_LABEL' from='STATUS_LABELS.%s'|args:$DRAFT_STATUS}}

{{:assign title='%s n°%s'|args:$document_type_label:$key}}

{{if $_GET.source === 'details'}}
	{{:assign back='details.html?id=%d&show=%s'|args:$id:$type}}
{{else}}
	{{:assign back='./'}}
{{/if}}
{{:include
	file='receipt/_header.html'
	page='A5'
	title=$title|cat:' - ':$subject
	hide_header=true
	back_link=$back
}}

{{if $config.files.logo}}
	<img src="{{$config.files.logo}}&150px" alt="Logo" style="float: left; min-width: 64px; min-height: 64px; margin: 0em 1em 1em 0em;" />
{{/if}}

<h2 class="organization_name">{{$config.org_name}}</h2>
<ul class="organization_details">
	{{if $vat_exemption === $NONPROFIT_VAT_EXEMPTION_TYPE}}
		<li>Association « loi 1901 » à but non lucratif{{if $siret}} — SIRET {{$siret}}{{/if}}</li>
	{{/if}}
	<li>{{$config.org_address|escape|nl2br}}</li>
	{{if $config.org_web}}
		<li>{{$config.org_web}}</li>
	{{/if}}
	<li>Contact : {{$org_contact}}</li>
</ul>

<ul class="customer_details">
	<li>
		<strong class="business_name">{{$recipient_business_name}}</strong><br />
		{{$recipient_address|escape|nl2br}}
	</li>
	{{if $recipient_member_number || $recipient_member_id}}
		<li>Réf. membre : {{if $recipient_member_number}}{{$recipient_member_number}}{{else}}#{{$recipient_member_id}}{{/if}}</li>
	{{/if}}
</ul>

<h1>
	Objet : {{$title}}
	{{if $status === $DRAFT_STATUS}} - <span class="important_status">{{$DRAFT_LABEL}}</span>
	{{elseif $cancelled}} - <span class="important_status">{{$CANCELLED_LABEL}}</span>
	{{/if}}
</h1>
<ul class="document_details">
	<li>Date : {{$date|date_short}}</li>
	<li>Référence : {{$key}}</li>
	<li>Intitulé : {{$subject}}</li>
	{{if !$introduction_text}}
		<li>Montant : {{$total|money_currency}}</li>
	{{/if}}
</ul>

{{if $introduction_text}}
	<p>
		{{$introduction_text|escape|nl2br}}
	</p>
{{/if}}

<h2>Articles</h2>
{{if $items}}
	<table id="item_list" class="list">
		<thead>
			<tr>
				<th>Réf.</th>
				<th>Dénomination</th>
				<th>Description</th>
				<th class="number">Prix unitaire</th>
				<th class="number">Quantité</th>
			</tr>
		</thead>
		<tbody>
		{{#foreach from=$items item='item'}}
			<tr>
				<td>{{$item.reference}}</td>
				<td>{{$item.name}}</td>
				<td>{{$item.description|escape|nl2br}}</td>
				<td class="number">{{$item.unit_price|intval|money_currency:false}}</td>
				<td class="number">{{$item.quantity|floatval}}</td>
			</tr>
		{{/foreach}}
		</tbody>
		<tfooter>
			<tr>
				<td colspan="4" class="total">TOTAL</td>
				<td class="total">{{$total|intval|money_currency:false}}</td>
			</tr>
		</tfooter>
	</table>
	
	<p>
		{{if $vat_exemption === $NONPROFIT_VAT_EXEMPTION_TYPE}}
			Association exonérée des impôts commerciaux (art. 261-7-1 du CGI).
		{{else}}
			TVA non-applicable, article 293 B du CGI.
		{{/if}}
	</p>
{{else}}
	<p>Aucun article.</p>
{{/if}}

{{if $deadline}}
<p>
	<strong>Devis valable jusqu'au {{$deadline|date_short}}.</strong>
</p>
{{/if}}

{{if $payment_text || $extra_text}}
	<h3>Informations</h3>
	{{if $payment_text}}<p>{{$payment_text|escape|nl2br}}</p>{{/if}}
	{{if $extra_text}}<p>{{$extra_text|escape|nl2br}}</p>{{/if}}
{{/if}}

{{if $status === $DRAFT_STATUS}}
	{{:assign signing_date='0001-01-01' signing_place='XXXXXX'}}
{{/if}}

<p>
	<strong>Bon pour accord</strong> le {{$signing_date|date_short}},<br />
	à <span class="signing_place">{{$signing_place}}</span>.
</p>

{{if $status !== $DRAFT_STATUS && $config.files.signature}}
<figure>
	<img src="{{$config.files.signature}}" alt="Signature association" />
</figure>
{{/if}}

{{:include file="receipt/_footer.html"}}

{{/load}}

{{else}}
	{{:error message="Seuls les membres avec accès en lecture à la comptabilité peuvent visualiser cette page."}}
{{/restrict}}

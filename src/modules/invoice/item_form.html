{{:admin_header title="Ajouter un article au devis"}}

<script type="text/javascript">
{{* Reproduce brindille {{:input}} partial behavior *}}
function generate_item_input(type, name, index) {
	let input;

	if (type === 'textarea') {
		input = document.createElement('textarea');
		input.cols = 50;
		input.rows = 2;
	}
	else {
		input = document.createElement('input');
		input.type = type;
		if (type === 'money') {
			input.type = 'text';
			input.pattern = '-?[0-9]+([.,][0-9]{1,2})?';
			input.inputmode = 'decimal';
			input.size = 8;
			input.classList.add('money');
			input.autocomplete = 'off';
		}
	}
	if (name === 'unit_price' || name === 'quantity')
		input.classList.add('impact_total');
	if (name === 'reference')
		input.classList.add('reference');
	if (name === 'quantity') {
		input.min = 0;
		input.max = 9999;
	}
	input.name = 'items[' + index + '][' + name + ']';
	input.id = 'item_' + name + '_' + index;
	return (input);
}

function generate_item_empty_line() {
	let row_line;
	let index;

	row_line = document.createElement('tr');
	row_line.classList.add('item');
	row_line.classList.add('need_delete_button');
	index = window.parent.document.getElementById('item_list').getElementsByTagName('tbody')[0].children.length;
	row_line.id = 'item_' + index + '_row';
	row_line.setAttribute('data-item-id', index);
	return row_line;
}

function add_item() {
	let row_line;
	let td;
	let item_properties = [['reference', 'text'], ['name', 'text'], ['description', 'textarea'], ['unit_price', 'money'], ['quantity', 'number']];
	let input;
	let nobr;

	row_line = generate_item_empty_line();
	for (let i = 0; i < item_properties.length; ++i) {
		td = document.createElement('td');
		td.classList.add('item_' + item_properties[i][0]);
		input = generate_item_input(item_properties[i][1], item_properties[i][0], row_line.id);
		input.value = document.getElementById('f_item_' + item_properties[i][0]).value;
		if (item_properties[i][1] === 'money') {
			nobr = document.createElement('nobr');
			nobr.appendChild(input);
			input = nobr;
		}
		td.appendChild(input);
		row_line.appendChild(td);
	}
	window.parent.document.getElementById('item_list_no_item_message').style.display = 'none';
	window.parent.document.getElementById('item_list').style.display = 'block';
	window.parent.document.getElementById('item_list').getElementsByTagName('tbody')[0].appendChild(row_line);
	window.parent.refresh_total();
	window.parent.add_delete_buttons();
	window.parent.add_input_refresh_total_behavior();
	window.parent.g.closeDialog();
}
</script>

<form method="POST" action="" id="item_creation_form" onsubmit="add_item()">
	<fieldset>
		<legend><h2>Ajouter un article</h2></legend>
		<dl>
			{{:input type="text" name="item_reference" label="Référence" placeholder="ex : S-812"}}
			{{:input type="text" name="item_name" label="Dénomination" placeholder="ex : Location vélo - Forfait six jours"}}
			{{:input type="textarea" name="item_description" label="Description"}}

			<dt><label for="f_item_unit_price">Prix unitaire</label><i>(facultatif)</i></dt>
			<dd><input type="text" name="item_unit_price" id="f_item_unit_price" value="0" pattern="-?[0-9]+([.,][0-9]{1,2})?" inputmode="decimal" size="8" autocomplete="off" class="money" /></dd>
			{{* Awaiting #eeb7d3e36ef4e3d7f2e8bc49c18c3c6b672f2e18 resolution {{:input type="money" name="item_unit_price" id="item_unit_price" label="Prix unitaire" default="0"}} *}}

			{{:input type="number" name="item_quantity" label="Quantité" default="1" min="0" max="9999"}}
		</dl>
		<input type="submit" name="" id="item_addition_button" value="Ajouter l'article au devis" />
	</fieldset>
</form>

{{:admin_footer}}

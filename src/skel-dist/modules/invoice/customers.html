{{#restrict section="accounting" level="read"}}

{{* ==================== Header ==================== *}}

{{:admin_header title="Devis et factures" current="acc"}}
{{:include file='./include/style.tpl'}}
{{:include file='./include/navigation.html'}}
{{:include file='./include/constants.tpl' keep='DRAFT_STATUS, AWAITING_STATUS, VALIDATED_STATUS, REJECTED_STATUS'}}

{{* ==================== Listing ==================== *}}

{{#sql select='id' tables='module_data_invoice'}}
	{{:assign found=true}}
{{/sql}}

{{if !$found}}
	<p class="infos">Aucun devis.</p>
	{{#restrict section="accounting" level="write"}}
		<p class="infos">{{:linkbutton href="edit.html" label="Créer un devis" shape="plus"}}</p>
	{{/restrict}}
{{/if}}

<table class="list">
	<thead>
		<tr>
			<th>Nom</th>
			<th>Devis en attente</th>
			<th>Devis validés</th>
			<th>Devis rejetés</th>
			<th>Factures</th>
		</tr>
	</thead>
	<tbody>
{{:assign previous_customer='-1'}}
{{:assign previous=null}}
{{:assign var='status_number.%s'|args:$AWAITING_STATUS value=0}}
{{:assign var='status_number.%s'|args:$VALIDATED_STATUS value=0}}
{{:assign var='status_number.%s'|args:$REJECTED_STATUS value=0}}
{{#sql
	select="
		json_extract(document, '$.recipient_business_name') AS recipient_business_name,
		json_extract(document, '$.recipient_member_id') AS customer_id,
		json_extract(document, '$.status') AS status,
		COUNT(json_extract(document, '$.status')) AS document_status_quantity
	"
	tables='module_data_invoice'
	where="status != :draft_status"
	group='recipient_business_name, status'
	order='recipient_business_name, status'
	:draft_status=$DRAFT_STATUS
}}
	{{if $recipient_business_name !== $previous_customer && $previous_customer !== '-1'}}
		<tr>
			<td>{{:link href="./customer.html?show=customers&id=%s"|args:$previous.recipient_business_name label=$previous.recipient_business_name}}</td>
			<td>{{:assign var='number' from='status_number.%s'|args:$AWAITING_STATUS}}{{$number}}</td>
			<td>{{:assign var='number' from='status_number.%s'|args:$VALIDATED_STATUS}}{{$number}}</td>
			<td>{{:assign var='number' from='status_number.%s'|args:$REJECTED_STATUS}}{{$number}}</td>
			<td>-</td>
		</tr>
		{{:assign var='status_number.%s'|args:$AWAITING_STATUS value=0}}
		{{:assign var='status_number.%s'|args:$VALIDATED_STATUS value=0}}
		{{:assign var='status_number.%s'|args:$REJECTED_STATUS value=0}}
	{{/if}}
	{{:assign var='status_number.%s'|args:$status value=$document_status_quantity}}
	{{:assign previous_customer=$recipient_business_name}}
	{{:assign .='previous'}}
{{/sql}}

{{if $previous}}
	<tr>
		<td>{{:link href="./customer.html?show=customers&id=%s"|args:$previous.recipient_business_name label=$previous.recipient_business_name}}</td>
		<td>{{:assign var='number' from='status_number.%s'|args:$AWAITING_STATUS}}{{$number}}</td>
		<td>{{:assign var='number' from='status_number.%s'|args:$VALIDATED_STATUS}}{{$number}}</td>
		<td>{{:assign var='number' from='status_number.%s'|args:$REJECTED_STATUS}}{{$number}}</td>
		<td>-</td>
	</tr>
{{/if}}

	</tbody>
</table>

{{:admin_footer}}

{{else}}
	{{:error message="Seuls les membres avec accès en lecture à la comptabilité peuvent visualiser cette page."}}
{{/restrict}}

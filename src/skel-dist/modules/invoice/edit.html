{{#restrict section="accounting" level="write"}}

{{* ==================== Header ==================== *}}

{{:admin_header title="Devis et factures" current="acc"}}
{{:include file='./include/style.tpl'}}
{{:include file='./include/navigation.html'}}

{{:include file='./include/constants.tpl' keep='type_labels, status_labels, status_options, VERSION'}}


{{if $_GET.id}}
	{{#load id=$_GET.id}}
		{{:assign .="document"}}
	{{/load}}
	<h1>Édition du devis n°{{$document.key}} "{{$document.subject}}"</h1>
{{else}}
	<h1>Création d'un devis</h1>
{{/if}}

{{if $document && $document.status !== 'draft'}}
	{{:error message="Ce document n'est plus un brouillon et ne peut plus être modifié"}}
{{/if}}

{{if $_POST.quotation_submit}}
	{{:assign computed_total=0}}
	{{:assign errors=null}}
	{{:assign items=null}}

	{{* Hack to get the unique element sine "$my_array|keys" and "$my_array|first" do not exist *}}
	{{#foreach from=$_POST.customer key='id' item='name'}}
		{{if $id != $id|intval|strtolower}} {{* Hack to check the data is a number *}}
			{{:assign var='errors.' value='Membre séléctionné invalide.'}}
		{{/if}}
		{{:assign customer_id=$id|intval}}
	{{/foreach}}
	{{if $customer_id !== null}}
		{{#users id=$customer_id}}
			{{:assign recipient_member_id=$id}}
			{{:assign recipient_member_numero=$numero|strtolower}} {{* Hack awaiting implementation of "|strval" *}}
			{{:assign recipient_business_name=$nom}}
			{{if $adresse}}{{:assign recipient_address=$adresse|cat:"\n":$code_postal:' ':$ville}}{{/if}}
		{{/users}}
	{{/if}}

	{{if $_POST.recipient_business_name}} {{* Manual input overrides member name *}}
		{{:assign recipient_business_name=$_POST.recipient_business_name}}
	{{/if}}
	{{if !$recipient_business_name}}
		{{:assign var='errors.' value='La raison sociale est obligatoire si vous ne sélectionnez pas de membre.'}}
	{{/if}}
	{{if $recipient_business_name|strlen > 128}}
		{{:assign length=$_POST.recipient_business_name|strlen}}
		{{:assign var='errors.' value="Raison sociale trop longue. %d caractères sur les 128 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.recipient_address}} {{* Manual input overrides member address *}}
		{{:assign recipient_address=$_POST.recipient_address}}
	{{/if}}
	{{if !$recipient_address}}
		{{:assign var='errors.' value="L'adresse est obligatoire si vous ne sélectionnez pas de membre ou si celui/celle-ci n'a pas d'adresse."}}
	{{/if}}
	{{if $recipient_address|strlen > 512}}
		{{:assign length=$recipient_address|strlen}}
		{{:assign var='errors.' value="Adresse trop longue. %d caractères sur les 512 autorisés."|args:$length}}
	{{/if}}

	{{if !$_POST.subject}}
		{{:assign var='errors.' value="L'objet est obligatoire."}}
	{{/if}}
	{{if $_POST.subject|strlen > 256}}
		{{:assign length=$_POST.subject|strlen}}
		{{:assign var='errors.' value="Objet trop long. %d caractères sur les 256 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.introduction_text|strlen > 256}}
		{{:assign length=$_POST.introduction_text|strlen}}
		{{:assign var='errors.' value="Texte d'introduction trop long. %d caractères sur les 256 autorisés."|args:$length}}
	{{/if}}

	{{:assign date=$_POST.date|date:'Y-m-d'}}
	{{:assign deadline=$_POST.deadline|date:'Y-m-d'}}

	{{if !$_POST.date}}
		{{:assign var='errors.' value="La date est obligatoire."}}
	{{/if}}
	{{if $_POST.date|date_short === null}} {{* Means data is not a date *}}
		{{:assign var='errors.' value="La date du devis doit être une date."}}
	{{/if}}
	{{if $_POST.deadline && ($_POST.deadline|date_short === null)}}
		{{:assign var='errors.' value="L'échéance doit être une date."}}
	{{/if}}
	{{if $deadline && $deadline < $date}}
		{{:assign var='errors.' value="L'échéance doit se situer après la date du devis (%s)."|args:$_POST.date}}
	{{/if}}

	{{if !$_POST.status}}
		{{:assign var='errors.' value="Le statut est obligatoire."}}
	{{/if}}
	{{:assign var='allowed_status' from='status_options.%s'|args:$_POST.status}}
	{{if !$allowed_status}}
		{{:assign var='errors.' value='Statut invalide.'}}
	{{/if}}
	{{if $_POST.status === 'validated' && (!$_POST.signing_place || !$_POST.signing_date)}}
		{{:assign var='errors.' value='Si vous choisissez le statut "validé", vous devez indiquer le lieu et la date de signature du devis.'}}
	{{/if}}

	{{if !$_POST.contact_info}}
		{{:assign var='errors.' value="Le contact est obligatoire."}}
	{{/if}}
	{{if $_POST.contact_info|strlen > 256}}
		{{:assign length=$_POST.contact_info|strlen}}
		{{:assign var='errors.' value="Contact trop long. %d caractères sur les 256 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.payment_detail|strlen > 512}}
		{{:assign length=$_POST.payment_detail|strlen}}
		{{:assign var='errors.' value="Instructions de paiement trop longues. %d caractères sur les 512 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.extra_info|strlen > 1024}}
		{{:assign length=$_POST.extra_info|strlen}}
		{{:assign var='errors.' value="Informations complémentaires trop longues. %d caractères sur les 1024 autorisés."|args:$length}}
	{{/if}}

	{{#foreach from=$_POST.items key='index' item='item'}}
		{{if $item.name === ''}}{{:assign var='errors.' value="Le nom de l'article est requis."}}{{/if}}
		{{:assign var='unit_price' value=$item.unit_price|replace:',':'.'}}
		{{:assign var='quantity' value=$item.quantity|replace:',':'.'}}
		{{if $unit_price < 0 || $unit_price != $unit_price|floatval|strtolower}} {{* Hack to check the data is a number *}}
			{{:assign var='errors.' value='Le prix saisi pour "%s" est invalide.'|args:$item.name}}
		{{/if}}
		{{if $quantity < 0 || $quantity != $quantity|floatval|strtolower}}{{:assign var='errors.' value='La quantité saisie pour "%s" est invalide.'|args:$item.name}}{{/if}}

		{{if $item.reference|strlen > 128}}
			{{:assign length=$item.reference|strlen}}
			{{:assign shorted=$item.reference|substr:0:16|cat:'...'}}
			{{:assign var='errors.' value="Référence d'article '%s' trop longue. %d caractères sur les 128 autorisés."|args:$shorted:$length}}
		{{/if}}
		{{if $item.name|strlen > 128}}
			{{:assign length=$item.name|strlen}}
			{{:assign shorted=$item.name|substr:0:16|cat:'...'}}
			{{:assign var='errors.' value="Nom d'article '%s' trop long. %d caractères sur les 128 autorisés."|args:$shorted:$length}}
		{{/if}}
		{{if $item.description|strlen > 512}}
			{{:assign length=$item.description|strlen}}
			{{:assign var='errors.' value="Description de l'article '%s' trop longue. %d caractères sur les 512 autorisés."|args:$item.name:$length}}
		{{/if}}

		{{:assign var='computed_item' value=$item}}
		{{:assign var='computed_item.id' value=$index|intval}}
		{{:assign var='computed_item.unit_price' value=$unit_price|money_int}}
		{{:assign var='computed_item.quantity' value=$quantity|floatval}}
		{{:assign var='items.' value=$computed_item}}
		{{:assign var='computed_total' value="%d + %d * %F"|args:$computed_total:$computed_item.unit_price:$computed_item.quantity|math}}
	{{/foreach}}

	{{if ($computed_total != $_POST.quotation_total|money_int) || ($computed_total < 0)}}
		{{:assign var='errors.' value='Erreur de calcul du total. Enregistrement du devis refusé.'}}
	{{/if}}
	{{if $module.config.vat_exemption}}
		{{:assign vat_exemption=$module.config.vat_exemption}}
	{{else}}
		{{:assign vat_exemption='nonprofit'}}
	{{/if}}

	{{if ($_POST.signing_place || $_POST.signing_date) && $_POST.status !== 'validated'}}
		{{:assign var='errors.' value='Vous ne pouvez saisir le lieu et la date de signature du devis que si le statut est définit à "validé".'|cat:"\n":'Si vous ne souhaitez pas valider le devis maintenant, laissez vide le lieu et la date de signature.'}}
	{{/if}}

	{{if $_POST.signing_place|strlen > 128}}
		{{:assign length=$_POST.signing_place|strlen}}
		{{:assign var='errors.' value="Lieu de da signature trop long. %d caractères sur les 128 autorisés."|args:$length}}
	{{/if}}
	{{:assign signing_date=$_POST.signing_date|date:'Y-m-d'}}
	{{if $signing_date && $signing_date < $date}}
		{{:assign var='errors.' value="La date de signature doit se situer après la date du devis (%s)."|args:$_POST.date}}
	{{/if}}

	{{if $errors|count}}
		{{#foreach from=$errors item='error'}}
			<p class="error block">{{$error}}</p>
		{{/foreach}}
	{{else}}
		{{if $_POST.key}}
			{{:assign key=$_POST.key}}
		{{else}}
			{{#load select="MAX(key) AS last" where="json_extract(document, '$.type') = :type" :type='quotation'}} 
				{{:assign last_numeric=$last|regexp_replace:'~\D~':''}}
				{{:assign next_numeric='%d+1'|math:$last_numeric}}
				{{:assign key="D%06d"|args:$next_numeric}}
			{{/load}}
		{{/if}}
		{{if $document}}
			{{:assign id=$document.id|intval}}
		{{else}}
			{{:assign id=null}}
		{{/if}}

		{{:save 
			validate_schema="./quotation.schema.json"
			id=$id
			key=$key
			type='quotation'
			recipient_business_name=$recipient_business_name
			recipient_address=$recipient_address
			recipient_member_id=$recipient_member_id
			recipient_member_numero=$recipient_member_numero
			introduction_text=$_POST.introduction_text
			subject=$_POST.subject
			date=$date
			deadline=$deadline
			status=$_POST.status
			items=$items
			total=$computed_total
			vat_exemption=$vat_exemption
			siret=$module.config.siret
			contact_info=$_POST.contact_info
			signing_place=$_POST.signing_place
			signing_date=$signing_date
			payment_detail=$_POST.payment_detail
			extra_info=$_POST.extra_info
			module_version=$VERSION
		}}

		{{if !$document}}
			{{:http redirect="./index.html?ok=1"}}
		{{else}}
			{{:http redirect="./index.html?ok=2"}}
		{{/if}}

	{{/if}}
{{/if}}

<form method="POST" action="{{$request_url}}">
	<fieldset>
		<legend><h2>Destinataire</h2></legend>
		<fieldset>
			<legend>Membre enregistré.e</legend>
			{{if $document.recipient_member_id}}
				{{#users id=$document.recipient_member_id|intval}}{{:assign .='user'}}{{/users}}
				{{if $user}}
					{{:assign var='default_customer_selection.%s'|args:$document.recipient_member_id value=$user.nom}}
				{{/if}}
			{{/if}}
			{{:input type="list" name="customer" required=false label="Membre" target="!users/selector.php" default=$default_customer_selection can_delete=true}}
			{{if $document.recipient_member_id && !$user}}
				<p class="infos">
					Attention : Ce devis est associé à l'ancien.ne membre
					{{if $document.recipient_member_numero}}n°{{$document.recipient_member_numero}}{{else}}#{{$document.recipient_member_id}}{{/if}}
					dont le compte est supprimé.<br />
					Mettre à jour ce document des-associera cet ancien compte.
				</p>
			{{/if}}
		</fieldset>
		<fieldset>
			<legend>Saisie manuelle<label for="manual_input_priority_help">*</label></legend>
			{{:input type="text" name="recipient_business_name" label="Raison sociale" source=$document placeholder="ex : SARL J'aime les deux vies"}}
			{{:input type="textarea" name="recipient_address" label="Adresse" source=$document placeholder=""}}
			<p class="infos" id="manual_input_priority_help">*Si un membre est associé au document, la saisie manuelle est prioritaire sur le nom et l'adresse.</p>
		</fieldset>
	</fieldset>

	{{* Default values (only) for new documents *}}
	{{if !$document}}
		{{:assign contact_info_default=$config.org_email}}
		{{:assign introduction_text_helper='La valeur pré-remplie de ce texte est modifiable dans la configuration du module.'}}
		{{:assign introduction_text_default=$module.config.introduction_text}}
		{{:assign payment_detail_default=$module.config.payment_detail}}
		{{:assign extra_info_default=$module.config.quotation_extra_info}}
	{{else}}
		{{:assign contact_info_default=null}}
		{{:assign introduction_text_helper=null}}
		{{:assign introduction_text_default=null}}
		{{:assign payment_detail_default=null}}
		{{:assign extra_info_default=null}}
	{{/if}}

	<fieldset>
		<legend><h2>Objet</h2></legend>
		<ul>
			<li>{{:input type="text" name="key" label="Numéro" source=$document help="Ce numéro doit être unique. Laisser vide pour générer un nouveau numéro."}}</li>
			<li>{{:input type="text" name="subject" label="Intitulé" source=$document placeholder="ex : Devis pour une location de barnum" required=true}}</li>
			<li>{{:input type="date" name="date" label="Date du devis" source=$document placeholder="" required=true}}</li>
			<li>{{:input type="date" name="deadline" label="Échéance pour validation" source=$document placeholder="" required=false}}</li>
			<li>{{:input type="text" name="contact_info" label="Contact" source=$document default=$contact_info_default required=true}}</li>
			<li>
				<dt><label for="status">Statut</label></dt>
				<dd>
					{{:input type="select" name="status" options=$status_options source=$document default=$status required=true}}
				</dd>
			</li>
			<li>
				{{:input type="textarea" name="introduction_text" label="Texte d'introduction" source=$document default=$introduction_text_default placeholder="ex : Formule de politesse." help=$introduction_text_helper required=false cols="50" rows="4"}}
			</li>
		</ul>
	</fieldset>

	{{:assign items=$document.items}}
	{{:include file='./include/item_list.tpl'}}

	{{if $module.config.payment_detail || $module.config.quotation_extra_info}}
		<fieldset>
			<legend><h2>Informations complémentaires affichées en bas du devis</h2></legend>
			<ul>
			{{if $module.config.payment_detail}}
				<li>{{:input type="textarea" name="payment_detail" label="Instructions de paiement" source=$document default=$payment_detail_default cols="50" rows="5"}}</li>
			{{/if}}
			{{if $module.config.quotation_extra_info}}
				<li>{{:input type="textarea" name="extra_info" label="Informations complémentaires" source=$document default=$extra_info_default cols="50" rows="2"}}</li>
			{{/if}}
			</ul>
		{{if !$document}}<p>(La valeur pré-remplie de ces informations est modifiable dans la configuration du module.)</p>{{/if}}
		</fieldset>
	{{/if}}

	<fieldset>
		<legend><h2>Signature du devis</h2></legend>
		{{if $status === 'validated'}}
			{{:assign signed=true}}
		{{else}}
			{{:assign signed=false}}
		{{/if}}
		<p id="signing_confirmation_p" style="display: block;">
			{{* Duplicate {{:input}} awaiting #51c881285662a356968ba943b7ce7956adc3b865 resolution *}}
			{{if $signed}}
				{{:input type="checkbox" name="signing" id="debug" label="Signer le devis" value="" checked=true}}
			{{else}}
				{{:input type="checkbox" name="signing" id="debug" label="Signer le devis" value=""}}
			{{/if}}
		</p>
		<p id="signing_warning" class="infos">
			À ne remplir que si vous souhaitez valider immédiatement le devis.<br />
			Le <label for="f_status">statut du devis</label> doit donc être définit sur "Validé".
		</p>
		<ul id="signing_inputs">
			<li>{{:input type="text" name="signing_place" label="Lieu de la signature" placeholder="ex : Dijon" source=$document}}</li>
			<li>{{:input type="date" name="signing_date" label="Date de la signature" source=$document}}</li>
		</ul>
	</fieldset>

	<p class="submit">
		{{if !$document}}
			{{:button type="submit" name="quotation_submit" label="Valider la création de devis" class="main"}}
		{{else}}
			{{:button type="submit" name="quotation_submit" label="Modifier le devis" class="main"}}
		{{/if}}
	</p>
</form>

{{:admin_footer}}

<script type="text/javascript">
	let target;

	document.getElementById('signing_warning').style.display = 'none';
	document.getElementById('signing_inputs').style.display = 'none';
	target = document.getElementById('f_signing_place');
	target.disabled = 'disabled';
	{{if !$document || !$document.signing_place}}
		target.value = '{{$module.config.signing_place}}';
	{{/if}}
	target = document.getElementById('f_signing_date');
	target.disabled = 'disabled';
	{{if !$document || !$document.signing_date}}
		target.value = '{{$now|date_short}}';
	{{/if}}
	document.getElementById('f_signing_').onclick = () => {
		let target;
		
		target = document.getElementById('signing_inputs');
		target.style.display = (target.style.display === 'none' ? 'block' : 'none');
		document.getElementById('f_signing_place').disabled = !document.getElementById('f_signing_place').disabled;
		document.getElementById('f_signing_date').disabled = !document.getElementById('f_signing_date').disabled;
		target = document.getElementById('f_status');
		target.value = (target.value !== 'validated' ? 'validated' : '{{if !$document}}draft{{else}}{{$document.status}}{{/if}}');
	};
</script>

{{else}}
	{{:error message="Seuls les membres avec accès en écriture à la comptabilité peuvent générer ce document."}}
{{/restrict}}
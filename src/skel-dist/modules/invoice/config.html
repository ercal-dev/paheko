{{:assign page_title="Configuration du module “Devis et factures”"}}
{{:admin_header title=$page_title}}

{{:include file='./include/constants.tpl' keep='vat_exemption_type'}}

{{if $_POST.save}}
	{{:assign var='allowed_type' from='vat_exemption_type.%s'|args:$_POST.vat_exemption}}
	{{if !$allowed_type}}
		{{:assign var='errors.' value="Type d'association invalide."}}
	{{/if}}
	{{if $_POST.siret|strlen > 14}}
		{{:assign length=$_POST.siret|strlen}}
		{{:assign var='errors.' value="Numéro SIRET trop long. %d caractères sur les 14 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.signing_place|strlen > 128}}
		{{:assign length=$_POST.signing_place|strlen}}
		{{:assign var='errors.' value="Ville de signature des devis trop longue. %d caractères sur les 128 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.introduction_text|strlen > 256}}
		{{:assign length=$_POST.introduction_text|strlen}}
		{{:assign var='errors.' value="Texte d'introduction devis trop long. %d caractères sur les 256 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.payment_detail|strlen > 512}}
		{{:assign length=$_POST.payment_detail|strlen}}
		{{:assign var='errors.' value="Instructions de paiement devis trop longues. %d caractères sur les 512 autorisés."|args:$length}}
	{{/if}}
	{{if $_POST.quotation_extra_info|strlen > 512}}
		{{:assign length=$_POST.quotation_extra_info|strlen}}
		{{:assign var='errors.' value="Informations complémentaires trop longues. %d caractères sur les 512 autorisés."|args:$length}}
	{{/if}}
	{{if !$errors}}
		{{:save key="config"
			validate_schema="./config.schema.json"
			vat_exemption=$_POST.vat_exemption
			siret=$_POST.siret
			signing_place=$_POST.signing_place
			introduction_text=$_POST.introduction_text
			payment_detail=$_POST.payment_detail
			quotation_extra_info=$_POST.quotation_extra_info
		}}
		{{:http redirect="?ok=1"}}
	{{/if}}
{{/if}}

<h1 class="ruler">{{$page_title}}</h1>
<form method="POST" action="{{$self_url}}">
	<p class="infos">
		Conformement à la législation, le changement de ces informations n'impactera que les futurs devis/factures. Les devis et factures déjà rédigés ne tiennent pas compte de ces modifications.
	</p>
	{{if $errors}}
		{{#foreach from=$errors item='error'}}
			<p class="error block">{{$error}}</p>
		{{/foreach}}
	{{elseif $_GET.ok}}
		<p class="block confirm">Configuration enregistrée. <br />
		{{:link href="#" label="Retour à la page des extensions" onclick="window.parent.g.closeDialog()"}}<br />
		</p>
	{{/if}}
	<fieldset>
		<legend>Caractéristiques de l'association</legend>
		{{:input type="radio" name="vat_exemption" label="Association non-lucrative" value="nonprofit" help="art. 261-7-1 du CGI" required=true default=$module.config.vat_exemption}}
		{{:input type="radio" name="vat_exemption" label="Association lucrative" value="profit" help="franchise en base de TVA, art. 293 B du CGI" required=true default=$module.config.vat_exemption}}
		{{:input type="text" name="siret" label="Numéro SIRET" required=false default=$module.config.siret}}
		{{:input type="text" name="signing_place" label="Ville de signature des devis" required=false default=$module.config.signing_place}}
	</fieldset>
	<fieldset>
		<legend>Informations</legend>
		{{:input required=false name="introduction_text" type="textarea" label="Texte d'introduction" source=$module.config default="Madame, Monsieur,\nSuite à votre demande, veuillez trouver ci-dessous notre proposition de devis." placeholder="ex : Formule de politesse." cols="50" rows="4"}}
		{{:input required=false name="payment_detail" type="textarea" label="Instructions de paiement" default=$module.config.payment_detail placeholder="BIC :&#10;ABCDEFGH012&#10;FR9901234567890123456789012&#10;La banque eh! tic&#10;&#10;Paiement à réaliser sous 15 jours." cols="50" rows="5"}}
		{{:input required=false name="quotation_extra_info" type="textarea" label="Informations complémentaires affichées en bas des devis" default=$module.config.quotation_extra_info placeholder="ex : Formule de politesse." cols="50" rows="3"}}
	</fieldset>
	{{:button type="submit" name="save" label="Enregistrer la configuration" class="main"}}
</form>

{{:admin_footer}}

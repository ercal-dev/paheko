{{if $logged_user.perm_accounting < $access_level.write}}
	{{:error message="Seuls les membres avec accès en écriture à la comptabilité peuvent générer ce document"}}
{{/if}}
{{:admin_header title="Devis et factures" current="acc"}}

<nav class="tabs">
	<aside>
		{{:linkbutton href="edit.html" label="Nouveau document" shape="plus" target="_dialog"}}
	</aside>

	<ul>
		<li{{if !$_GET.show}} class="current"{{/if}}><a href="./">Tous les documents</a></li>
		<li{{if $_GET.show == 'quotation'}} class="current"{{/if}}><a href="./?show=quotation">Devis</a></li>
		<li{{if $_GET.show == 'unpaid'}} class="current"{{/if}}><a href="./?show=unpaid">Factures en souffrance</a></li>
		<li{{if $_GET.show == 'paid'}} class="current"{{/if}}><a href="./?show=paid">Factures réglées</a></li>
		<li><a href="clients.html">Clients</a></li>
	</ul>
</nav>

{{if $_GET.show == 'quote'}}
	{{:assign filter="json_extract(value, '$.type') = 'quotation'"}}
{{elseif $_GET.show == 'paid'}}
	{{:assign filter="json_extract(value, '$.type') = 'invoice' AND json_extract(value, '$.date_paid') IS NOT NULL"}}
{{elseif $_GET.show == 'unpaid'}}
	{{:assign filter="json_extract(value, '$.type') = 'invoice' AND json_extract(value, '$.date_paid') IS NULL"}}
{{else}}
	{{:assign filter="1"}}
{{/if}}

<table class="list">
	<thead>
		<tr>
			<th>Numéro</th>
			<td>Émission</td>
			<td>Échéance</td>
			<td>Tiers</td>
			<td>Intitulé</td>
			<td class="money">Montant</td>
			<td>Statut</td>
			<td></td>
		</tr>
	</thead>
	<tbody>
{{#load where="key != 'config' AND %s"|args:$filter select="value AS json, key, datetime(json_extract(value, '$.date')) AS date" order="date DESC"}}
		<tr>
			<th>{{$key}}</th>
			<td>{{$date|date_short}}</td>
			<td>{{$deadline|date_short}}</td>
			<td>{{$recipient_business_name}}</td>
			<td>{{$subject}}</td>
			<td class="money">{{$total|raw|money_currency}}</td>
			<td>
				{{if $archived}}
					Archivé
				{{elseif $date_paid}}
					Payé le {{$date_paid|date_short}}
				{{elseif $type == 'invoice'}}
					En attente
				{{/if}}
			</td>
			<td class="actions">
				{{if !$archived}}
				{{:linkbutton shape="edit" label="Modifier" href="edit.html?key=%s"|args:$key}}
				{{/if}}
			</td>
		</tr>
{{else}}
		<tr><td colspan="6">Aucun document</td></tr>
{{/load}}
</tbody>
</table>

<h1>Création dun devis</h1>

{{if $_POST.quotation_submit}}
	<!-- Todo: add a nice error check here -->
	{{if $error}}
		<p class="error block">{{$error}}</p>
	{{else}}
		{{:assign new_key="%d+1"|math:$module.config.last_id}}
		{{:assign id="%d+1"|math:$module.config.last_quotation_id}}

		{{:save key="quotation_"|cat:$id
			validate_schema="./quotation.schema.json"
			id=$new_key
			recipient_business_name=$_POST.recipient_business_name
			recipient_address=$_POST.recipient_address
			subject=$_POST.subject
			date=$_POST.date
			deadline=$_POST.deadline
			contact_info=$_POST.contact_info
		}}
		{{:save key="config" last_id=$new_key last_quotation_id=$id}}
		{{:http redirect="?ok=1"}}
	{{/if}}
{{elseif $_GET.ok}}
	<p class="block confirm">Devis enregistré.</p>
{{/if}}

<form method="POST" action="">
	<fieldset>
		<legend><h2>Destinataire</h2></legend>
		{{:input type="text" name="recipient_business_name" label="Raison sociale" placeholder="ex : SARL J'aime les deux vies" required=true}}
		{{:input type="textarea" name="recipient_address" label="Adresse" placeholder="" required=true}}
	</fieldset>
	<fieldset>
		<legend><h2>Objet</h2></legend>
		<ul>
			<li>{{:input type="text" name="subject" label="Objet" placeholder="ex : Devis pour une location de barnum" required=true}}</li>
			<li>{{:input type="date" name="date" label="Date du devis" placeholder="" required=true}}</li>
			<li>{{:input type="date" name="deadline" label="Échéance pour validation" placeholder="" required=false}}</li>
			<li>{{:input type="text" name="contact_info" label="Contact" default=$config.org_email required=true}}</li>
		</ul>
	</fieldset>
	<fieldset>
		<legend><h2>Liste des articles</h2></legend>
		<p id="item_list_no_item_message">Aucun article pour le moment.</p>
		<table id="item_list" style="display: none;">
			<tr>
				<th>Dénomination</th>
				<th>Prix unitaire</th>
				<th>Quantité</th>
				<th>Total</th>
			</tr>
		</table>
		<p>{{:linkbutton label="Ajouter un article" href="item_form.html" shape="settings" target="_dialog"}}</p>
		<h3>Total des articles</h3>
		<p id="quotation_total">0 {{$config.currency}}</p>
	</fieldset>
	<input type="submit" name="quotation_submit" label="" value="Valider la création de devis" />
</form>

{{if $module.config.payment_detail || $module.config.bic}}
	<h2>Informations affichées en bas du devis</h2>
	{{if $module.config.payment_detail}}
		<p>
			{{$module.config.payment_detail}}
		</p>
	{{/if}}
	{{if $module.config.bic}}
		<p>
			BIC : {{$module.config.bic}}<br />
			IBAN : {{$module.config.iban}}<br />
			BANQUE : {{$module.config.bank}}
		</p>
	{{/if}}
	<p>(Ces informations sont modifiables dans la configuration du module.)</p>
{{/if}}

{{:admin_footer}}

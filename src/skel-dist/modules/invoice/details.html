{{#restrict section="accounting" level="read"}}

{{* ==================== Header ==================== *}}

{{:admin_header title="Devis et factures" current="acc"}}
{{:include file='./include/constants.tpl' keep='DRAFT_STATUS, VALIDATED_STATUS, TYPE_LABELS, STATUS_LABELS'}}

{{:include file='./include/style.tpl'}}

{{if $_POST.status_update_button}}
	{{#restrict block=true section="accounting" level="write"}}
		{{if !$_POST.id}}
			{{:error message='Aucun devis sélectionné:'}}
		{{else}}
			{{:assign var='new_status_label' from='STATUS_LABELS.%s'|args:$_POST.status}}
			{{if $new_status_label === null}}
				{{:assign var='errors[]' value='Nouveau statut invalide : %s.'|args:$_POST.status}}
			{{else}}
				{{#load id=$_POST.id|intval}}
					{{:save id=$id
						validate_schema="./schema/quotation.json"
						key=$key
						type=$type
						recipient_business_name=$recipient_business_name
						recipient_address=$recipient_address
						recipient_member_id=$recipient_member_id
						recipient_member_numero=$recipient_member_numero
						introduction_text=$introduction_text
						subject=$subject
						date=$date
						deadline=$deadline
						status=$_POST.status
						items=$items
						total=$total
						vat_exemption=$vat_exemption
						siret=$siret
						org_contact=$org_contact
						signing_place=$signing_place
						signing_date=$signing_date
						payment_detail=$payment_detail
						extra_info=$extra_info
						module_version=$module_version
					}}

					{{:http redirect="?id=%d&ok=1"|args:$id}}
				{{/load}}
			{{/if}}
			{{#foreach from=$errors item='error'}}
				<p class="error block">{{$error}}</p>
			{{/foreach}}
		{{/if}}
	{{/restrict}}
{{elseif $_GET.id === null}}
	<p class="error block">Aucun document séléctionné.</p>
{{else}}
	{{if $_GET.ok}}<p class="block confirm">Modification enregistrée.</p>{{/if}}
	{{#load id=$_GET.id|intval}}

		<nav class="tabs">
			<aside>
				{{:linkbutton href="edit.html" label="Nouveau devis" shape="plus"}}
				{{if $status == $DRAFT_STATUS}}
					{{:linkbutton href="./edit.html?id=%d"|args:$id label="Modifier le devis" shape="edit"}}
				{{else}} {{* Hack awaiting #ac34cf8f45a5a79815b16ea505da08ffad2268cf implementation *}}
					{{:button name="hack" title="Ce document n'est plus un brouillon et ne peut plus être modifié" label="Modifier le devis" disabled=true}}
				{{/if}}
			</aside>
			{{:include file='./include/main_nav_tabs.html'}}
		</nav>

		{{:assign var="label" from="TYPE_LABELS.%s"|args:$type}}
		<h1>{{$label}} n° {{$key}}</h1>
		
		<fieldset>
			<legend><h2>Statut</h2></legend>
			{{#restrict section="accounting" level="write"}}
			<div class="infos inline">
				<label for="f_status">Statut en cours :</label>
				<form method="POST" action="./details.html" style="display: inline;">
					{{:input type="select" name="status" options=$STATUS_LABELS default=$status required=true}}
					{{:input type="hidden" name="id" default=$id|intval}}
					{{:button type="submit" name="status_update_button" label="Modifier"}}
				</form>
			</div>
			{{else}}
				{{:assign var="label" from="STATUS_LABELS.%s"|args:$status}}
				<p>{{$label}}</p>
			{{/restrict}}
			{{if $status !== $DRAFT_STATUS}}
				<p>
				{{if $status === $VALIDATED_STATUS}}
					{{$label}} validé et <strong>signé le {{$signing_date|date_short}} à {{$signing_place}}</strong>.
				{{/if}}
				{{:linkbutton label="PDF" href="preview.html?id=%s"|args:$id shape="document"}}
				</p>
			{{else}}
				{{:linkbutton label="Voir l'aperçu" href="preview.html?id=%s"|args:$id shape="document"}}
			{{/if}}
		</fieldset>

		<fieldset>
			<legend><h2>Destinataire</h2></legend>
			<p class="infos">
				<strong>{{$recipient_business_name}}</strong><br />
				{{$recipient_address|escape|nl2br}}
			</p>
			{{if $recipient_member_id}}
				{{#users id=$recipient_member_id|intval}}{{:assign .='member'}}{{/users}}
				{{if !$member}}
					<p class="infos">Associé à l'ancien.ne membre {{if $recipient_member_numero}}n°{{$recipient_member_numero}}{{else}}#{{$recipient_member_id}}{{/if}} (compte supprimé).</p>
				{{else}}
					<p class="infos">
						Associé au membre {{if $recipient_member_numero}}n°{{$recipient_member_numero}}{{/if}} : "{{:link href="details.php?id=%d"|args:$member.id label=$member.nom}}",
						{{if $recipient_business_name !== $member.nom}} sous la désignation "{{$recipient_business_name}}".{{/if}}
					</p>
				{{/if}}
			{{/if}}
		</fieldset>
		
		<fieldset>
			<legend><h2>Objet</h2></legend>
			<ul>
				<li>Intitulé : {{$subject}}</li>
				<li>Date : {{$date|date_short}}</li>
				{{if $deadline}}<li>Échéance : {{$deadline|date_short}}</li>{{/if}}
				<li>Référence : {{$key}}</li>
				<li>Total : {{$total|floatval|money_currency:false}}</li>
			</ul>
		</fieldset>
		
		<fieldset>
			<legend><h2>Articles</h2></legend>
			{{if $items}}
				<table id="item_list" class="list">
					<tr>
						<th>Réf.</th>
						<th>Dénomination</th>
						<th>Description</th>
						<th>Prix unitaire</th>
						<th>Quantité</th>
					</tr>
					{{#foreach from=$items item='item'}}
						<tr>
							<td>{{$item.reference}}</td>
							<td>{{$item.name}}</td>
							<td>{{$item.description|escape|nl2br}}</td>
							<td>{{$item.unit_price|intval|money:false}}</td>
							<td>{{$item.quantity}}</td>
						</tr>
					{{/foreach}}
				</table>
			{{else}}
				<p>Aucun article.</p>
			{{/if}}
		</fieldset>
		
		<fieldset>
			<legend><h2>Infos</h2></legend>
			<ul>
				<li class="infos">Contact : {{$org_contact}}</li>
				{{if $introduction_text}}
					<li>
						Texte d'introduction :
						<p>{{$introduction_text|escape|nl2br}}</p>
					</li>
				{{/if}}
			</ul>
		</fieldset>
		
		{{if $payment_detail || $extra_info}}
			<fieldset>
				<legend><h2>Infos complémentaires</h2></legend>
				{{if $payment_detail}}<p>{{$payment_detail|escape|nl2br}}</p>{{/if}}
				{{if $extra_info}}<p>{{$extra_info|escape|nl2br}}</p>{{/if}}
			</fieldset>
		{{/if}}

	{{/load}}
{{/if}}

{{:admin_footer}}

{{else}}
	{{:error message="Seuls les membres avec accès en lecture à la comptabilité peuvent visualiser cette page."}}
{{/restrict}}
